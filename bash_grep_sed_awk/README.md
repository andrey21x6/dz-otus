# Инициализация системы. Systemd.

# **Prerequisite**

- Host OS: Ubuntu Desktop 20.04.4
- GNU bash, version 5.0.17(1)-release-(x86_64-pc-linux-gnu)
- flock from util-linux 2.34

# **Содержание ДЗ**

Написать скрипт для CRON, который раз в час будет формировать письмо и отправлять на заданную почту.
Необходимая информация в письме:

* Список IP адресов (с наибольшим кол-вом запросов) с указанием кол-ва запросов c момента последнего запуска скрипта;
* Список запрашиваемых URL (с наибольшим кол-вом запросов) с указанием кол-ва запросов c момента последнего запуска скрипта;
* Ошибки веб-сервера/приложения c момента последнего запуска;
* Список всех кодов HTTP ответа с указанием их кол-ва с момента последнего запуска скрипта.
* Скрипт должен предотвращать одновременный запуск нескольких копий, до его завершения.
* В письме должен быть прописан обрабатываемый временной диапазон.

# **Выполнение**

Написал скрипт для планировщика cron на BASH send_email.sh

В планировщике прописал запуск скрипта каждый час с блокировкой повторного запуска с помощью утилиты flock и файла send_email.lock
```
0 * * * * /usr/bin/flock -xn /var/lock/send_email.lock -c 'sh /root/send_email.sh'
```

### Описание работы скрипта

Ищет строку, где есть запись ___Start_Script_Send_Mail___ и забирает всё, что идёт после нее
```
awk 'go { print } $0 == "___Start_Script_Send_Mail___" { go = 1 }'
```

Регулярное выражение для IP адреса, ключ -о вытаскивает только его
```
grep -o -E "(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)"
```

Числовая сортировка
```
sort -n
```

Ищет одинаковые строки и в начале каждой строки выводит число, которое обозначает количество повторов
```
uniq -c
```

Убирает пустоты первого столбца
```
awk '{gsub(/^[ \t]+| [ \t]+$/,""); print $0 }'
```

Регулярное выражение для домена, ключ -о вытаскивает только его
```
grep -o -P "[a-zA-Z0-9][a-zA-Z0-9-]{1,61}[a-zA-Z0-9](?:\.[a-zA-Z]{2,})+"
```

Команда вытаскивает строки по ключевому слову
```
grep "error"
```

Регулярное выражение по шаблону, вытаскивает коды HTTP ответов
```
grep -o -E " HTTP/1.(0|1)\" [0-9]{3,3} "
```

Вытаскивает запись даты и времени предыдущего запуска скрипта
```
dateTimeOld=`cat log.log | awk 'go { print } $0 == "___Start_Script_Send_Mail___" { go = 1 }' | grep  '______' | cut -f 2 -d '*'`
  Чт 08 сен 2022 19:36:43 +05
```

Меняет в строке ___Start_Script_Send_Mail___ на ___OFF_Script_Send_Mail___ в лог-файле
```
sed -i -e "s/___Start_Script_Send_Mail___/___OFF_Script_Send_Mail___/g" log.log
```

Вставляет в конец лог-файла строку ___Start_Script_Send_Mail___
```
echo ___Start_Script_Send_Mail___ >> log.log
```

Вставляет в конец лог-файла дату и время
```
dateTimeIn=$(date)
echo ______*${dateTimeIn}*______ >> log.log
```

Вычисляет максимальное число в первом столбце файла ip_list.txt и заносит в переменную ipMax
```
ipMax=`awk '{if(max<$1){max=$1;line=$1}}END{print line}' ip_list.txt`
```

Записывает в файл ip_max.txt строки, которые содержат максимальное число (переменная $ipMax) в первом столбце файла ip_list.txt
```
cat ip_list.txt | grep "^${ipMax} " > ip_max.txt
```

Вычисляет максимальное число в первом столбце файла domains_list.txt и заносит в переменную ipMax
```
domainsMax=`awk '{if(max<$1){max=$1;line=$1}}END{print line}' domains_list.txt`
```

Записывает в файл http_max.txt строки, которые содержат максимальное число (переменная $httpMax) в первом столбце файла http_list.txt
```
cat http_list.txt | grep "^${httpMax} " > http_max.txt
```

Присваиваем значения переменным для отправки Email
```
ipListMax=`cat ip_max.txt`
domainsListMax=`cat domains_max.txt`
errorList=`cat error_list.txt`
httpList=`cat http_list.txt`
```












# **Результаты**

- Полученный в ходе работы `Vagrantfile` помещен в публичный репозиторий:
**GitHub** - https://github.com/andrey21x6/dz-otus/tree/main/systemd
- Написал service, который раз в 30 секунд мониторить лог на предмет наличия ключевого слова
- Из репозитория epel установил spawn-fcgi и переписал init-скрипт на unit-файл
- Дополнил unit-файл httpd возможностью запустить несколько инстансов сервера с разными конфигурационными файлами

