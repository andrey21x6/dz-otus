# Инициализация системы. Systemd.

# **Prerequisite**

- Host OS: Ubuntu Desktop 20.04.4

# **Содержание ДЗ**

Написать скрипт для CRON, который раз в час будет формировать письмо и отправлять на заданную почту.
Необходимая информация в письме:

* Список IP адресов (с наибольшим кол-вом запросов) с указанием кол-ва запросов c момента последнего запуска скрипта;
* Список запрашиваемых URL (с наибольшим кол-вом запросов) с указанием кол-ва запросов c момента последнего запуска скрипта;
* Ошибки веб-сервера/приложения c момента последнего запуска;
* Список всех кодов HTTP ответа с указанием их кол-ва с момента последнего запуска скрипта.
* Скрипт должен предотвращать одновременный запуск нескольких копий, до его завершения.
* В письме должен быть прописан обрабатываемый временной диапазон.

# **Выполнение**

### Описание работы скрипта

Ищет строку, где есть запись Start___Script___Send___Mail и забирает всё, что идёт после нее
```
awk 'go { print } $0 == "Start___Script___Send___Mail" { go = 1 }'
```

Регулярное выражение для IP адреса, ключ -о вытаскивает только его
```
grep -o -E "(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)"
```

Числовая сортировка
```
sort -n
```

Ищет одинаковые строки и в начале каждой строки выводит число, которое обозначает количество повторов
```
uniq -c
```

Убирает пустоты первого столбца
```
awk '{gsub(/^[ \t]+| [ \t]+$/,""); print $0 }'
```

Регулярное выражение для домена, ключ -о вытаскивает только его
```
grep -o -P "[a-zA-Z0-9][a-zA-Z0-9-]{1,61}[a-zA-Z0-9](?:\.[a-zA-Z]{2,})+"
```

Команда вытаскивает строки по ключевому слову
```
grep "error"
```

Регулярное выражение по шаблону, вытаскивает коды HTTP ответов
```
grep -o -E " HTTP/1.(0|1)\" [0-9]{3,3} "
```

Меняет в строке Start___Script___Send___Mail на OFF___Start___Script___Send___Mail в лог-файле
```
sed -i -e "s/Start___Script___Send___Mail/OFF___Start___Script___Send___Mail/g" log.log
```

Вставляет в конец лог-файла строку Start___Script___Send___Mail
```
echo Start___Script___Send___Mail >> log.log
```

Вычисляет максимальное число в первом столбце файла ip_list.txt и заносит в переменную ipMax
```
ipMax=`awk '{if(max<$1){max=$1;line=$1}}END{print line}' ip_list.txt`
```

Записывает в файл ip_max.txt строки, которые содержат максимальное число (переменная $ipMax) в первом столбце файла ip_list.txt
```
cat ip_list.txt | grep "^${ipMax} " > ip_max.txt
```













# **Результаты**

- Полученный в ходе работы `Vagrantfile` помещен в публичный репозиторий:
**GitHub** - https://github.com/andrey21x6/dz-otus/tree/main/systemd
- Написал service, который раз в 30 секунд мониторить лог на предмет наличия ключевого слова
- Из репозитория epel установил spawn-fcgi и переписал init-скрипт на unit-файл
- Дополнил unit-файл httpd возможностью запустить несколько инстансов сервера с разными конфигурационными файлами

